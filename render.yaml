# =================================================================================
# render.yaml - PRODUCTION CONFIGURATION (29.10.2025)
# Описание: Telegram бот в режиме long polling (worker)
# ✅ ИСПРАВЛЕНО: Правильная конфигурация для предотвращения конфликтов
# ✅ ДОБАВЛЕНО: numInstances: 1 для предотвращения множественных экземпляров
# =================================================================================

services:
  # ==================== TELEGRAM BOT WORKER ====================
  - type: worker  # ✅ Worker (не web) - правильно для polling режима
    name: telegram-crypto-bot-worker
    runtime: python
    region: frankfurt  # Или другой регион (oregon, singapore, etc.)
    plan: free  # Для production рекомендуется starter ($7/мес)
    
    # Build команда
    buildCommand: |
      pip install --upgrade pip setuptools wheel
      pip install --break-system-packages -r requirements.txt
    
    # Start команда
    startCommand: python -m bot.main
    
    # Количество экземпляров (КРИТИЧНО: только 1 для polling режима!)
    numInstances: 1  # ✅ НЕ УВЕЛИЧИВАТЬ! Только 1 экземпляр для polling
    
    # Переменные окружения
    envVars:
      # =================================================================
      # ОБЯЗАТЕЛЬНЫЕ ПЕРЕМЕННЫЕ (установить вручную в Render Dashboard)
      # =================================================================
      - key: BOT_TOKEN
        sync: false  # ❗ Секретное значение! Установить в Dashboard
      
      - key: REDIS_URL
        sync: false  # ❗ Формат: redis://host:port или через Render Redis addon
      
      - key: GEMINI_API_KEY
        sync: false  # ❗ Google Gemini API key
      
      - key: ADMIN_USER_IDS
        value: "123456789"  # ⚠️ ЗАМЕНИТЬ на реальные Telegram user IDs через запятую!
      
      # =================================================================
      # ОПЦИОНАЛЬНЫЕ API КЛЮЧИ
      # =================================================================
      - key: OPENAI_API_KEY
        sync: false  # Опционально для OpenAI
      
      - key: COINGECKO_API_KEY
        sync: false  # Опционально для CoinGecko Pro API
      
      - key: CRYPTOCOMPARE_API_KEY
        sync: false  # Опционально для CryptoCompare API
      
      # =================================================================
      # TELEGRAM ЧАТЫ ДЛЯ УВЕДОМЛЕНИЙ
      # =================================================================
      - key: ADMIN_CHAT_ID
        sync: false  # Telegram chat ID для админ-уведомлений
      
      - key: NEWS_CHAT_ID
        sync: false  # Telegram chat ID для автопостинга новостей
      
      # =================================================================
      # СИСТЕМНЫЕ НАСТРОЙКИ (НЕ ИЗМЕНЯТЬ)
      # =================================================================
      - key: PYTHON_VERSION
        value: "3.11"  # ✅ Python 3.11 - рекомендуется
      
      - key: IS_WEB_PROCESS
        value: "false"  # ✅ КРИТИЧНО! Polling mode (НЕ webhook)
      
      - key: PORT
        value: "10000"  # Не используется в worker режиме
      
      - key: LOG_LEVEL
        value: "INFO"  # DEBUG | INFO | WARNING | ERROR | CRITICAL
      
      # =================================================================
      # AI НАСТРОЙКИ
      # =================================================================
      - key: AI__PROVIDER
        value: "gemini"  # gemini | openai | none
      
      - key: AI__DEFAULT_TEMPERATURE
        value: "0.5"  # 0.0-1.0
      
      - key: AI__REQUEST_TIMEOUT
        value: "30"  # Секунды
    
    # Auto deploy при push в Git
    autoDeploy: true

# =================================================================================
# ВАЖНЫЕ ЗАМЕЧАНИЯ:
# 
# 1. ✅ numInstances: 1 - КРИТИЧНО!
#    Только 1 экземпляр для polling, иначе TelegramConflictError
#
# 2. ✅ Instance Lock:
#    Бот автоматически использует Redis lock для дополнительной защиты
#
# 3. ✅ Graceful Shutdown:
#    Корректное освобождение ресурсов при остановке
#
# 4. ✅ Мониторинг:
#    - Render Dashboard → Logs
#    - Telegram админ-уведомления
#
# =================================================================================