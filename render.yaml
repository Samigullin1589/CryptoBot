# ===============================================================
# Файл: render.yaml (ПРОДАКШН-ВЕРСИЯ, АВГУСТ 2025)
# Описание: Конфигурация для Render.com с разделением на web
#           и worker, Health Check и переменными окружения.
# ===============================================================
services:
  # Web-сервис: отвечает только на health checks, потребляет минимум ресурсов
  - type: web
    name: cryptobot-health
    env: python
    pythonVersion: "3.12.4"
    plan: free
    buildCommand: "pip install --upgrade pip && pip install aiohttp==3.9.5"
    startCommand: "python -m bot.health_check_server"
    envVars:
      - key: PYTHONPATH
        value: .
      - key: IS_WEB_PROCESS
        value: "true"
    healthCheck:
      path: /healthz
      initialDelaySeconds: 15

  # Worker: основной процесс бота, выполняет всю работу
  - type: worker
    name: cryptobot-worker
    env: python
    pythonVersion: "3.12.4"
    plan: starter
    buildCommand: "pip install --upgrade pip && pip install -r requirements.txt"
    startCommand: "python -m bot.main"
    envVars:
      - key: PYTHONPATH
        value: .
      - key: IS_WEB_PROCESS
        value: "false"
      - key: BOT_TOKEN
        sync: false
      - key: ADMIN_USER_IDS
        sync: false
      - key: GEMINI_API_KEY
        sync: false
      - key: COINGECKO_API_KEY
        sync: false
      - key: CRYPTOCOMPARE_API_KEY
        sync: false
      - key: ADMIN_CHAT_ID
        sync: false
      - key: NEWS_CHAT_ID
        sync: false
      - key: REDIS_URL
        fromService:
          type: redis
          name: cryptobot-redis
          property: connectionString

  # База данных Redis
  - type: redis
    name: cryptobot-redis
    ipAllowList: []
    plan: free
    maxmemoryPolicy: allkeys-lru