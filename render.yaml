# ===============================================================
# Файл: render.yaml (ПРОДАКШН-ВЕРСИЯ, АВГУСТ 2025)
# Описание: Конфигурация Render Blueprints: worker + Key Value (Redis).
# Документация: https://render.com/docs/blueprint-spec
# ===============================================================

services:
  # --- Фоновый worker: сам бот (aiogram 3) ---
  - type: worker
    runtime: python
    name: cryptobot-worker
    plan: starter
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
    startCommand: |
      python -m bot.main
    envVars:
      # Фикс версии Python согласно оф. документации Render:
      # https://render.com/docs/python-version
      - key: PYTHON_VERSION
        value: 3.12.11

      # Основные переменные (секреты вводятся вручную в дашборде)
      - key: BOT_TOKEN
        sync: false
      - key: ADMIN_USER_IDS
        sync: false
      - key: TZ
        value: Asia/Tbilisi
      - key: LOG_LEVEL
        value: INFO

      # Подключение к Key Value (Redis) из сервиса ниже:
      - key: REDIS_URL
        fromService:
          name: cryptobot-kv
          type: keyvalue
          property: connectionString

      # ИИ-ключи (по необходимости)
      - key: OPENAI_API_KEY
        sync: false
      - key: GEMINI_API_KEY
        sync: false

      # Внешние API (по необходимости)
      - key: CRYPTOCOMPARE_API_KEY
        sync: false
      - key: COINGECKO_API_KEY
        sync: false

  # --- Key Value (современная замена типа redis) ---
  - type: keyvalue
    name: cryptobot-kv
    plan: free           # допустим для Key Value
    ipAllowList: []      # доступ из приватной сети Render
    maxmemoryPolicy: allkeys-lru